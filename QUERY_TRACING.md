# Query Tracing Feature

## Overview
The application now includes comprehensive query tracing that shows exactly how your queries are being processed, from natural language input to SQL execution and results.

## Features

### ğŸ” What Gets Traced

1. **User Input**: The original question you asked
2. **Query Type**: Whether it's a SQL query or visualization request
3. **SQL Queries**: All SQL queries generated by the agent
4. **Agent Reasoning Steps**: 
   - ğŸ’­ Thoughts: Agent's reasoning process
   - âš™ï¸ Actions: Tools/actions the agent decides to take
   - ğŸ“¥ Action Inputs: Parameters passed to actions
   - ğŸ‘ï¸ Observations: Results from executing actions
   - âœ… Final Answer: The formatted response
5. **Query Results**: Data returned from the database
6. **Errors**: Any errors encountered during execution
7. **Execution Time**: How long the query took to process

## How to Use

### Enable/Disable Tracing
- Checkbox at the top: **"Show Query Traces"**
- When enabled, each response will show an expandable trace section
- Click on **"ğŸ” Query Trace"** to expand and see details

### Viewing Traces

1. **Ask a question** in the chat
2. **Wait for response**
3. **Look for the trace section** below the response
4. **Click to expand** and see:
   - SQL queries generated
   - Agent reasoning steps
   - Execution results
   - Performance metrics

## Example Trace Output

```
ğŸ” Query Trace
â”œâ”€ Timestamp: 2024-12-27 23:59:59
â”œâ”€ Query Type: sql
â”œâ”€ User Input: "What is the total revenue?"
â”œâ”€ Execution Time: 2.34s
â”‚
â”œâ”€ ğŸ“ SQL Queries Generated
â”‚  â””â”€ Query 1: SELECT SUM(sale_price) as total_revenue FROM order_items
â”‚
â”œâ”€ ğŸ¤– Agent Reasoning Steps
â”‚  â”œâ”€ ğŸ’­ Step 1: THOUGHT
â”‚  â”‚  "I need to calculate total revenue. This means summing 
â”‚  â”‚   sale_price from order_items table."
â”‚  â”‚
â”‚  â”œâ”€ âš™ï¸ Step 2: ACTION
â”‚  â”‚  "sql_db_query"
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“¥ Step 3: ACTION_INPUT
â”‚  â”‚  "SELECT SUM(sale_price) as total_revenue FROM order_items"
â”‚  â”‚
â”‚  â”œâ”€ ğŸ‘ï¸ Step 4: OBSERVATION
â”‚  â”‚  "Query returned: 12345678.90"
â”‚  â”‚
â”‚  â””â”€ âœ… Step 5: FINAL_ANSWER
â”‚     "The total revenue is $12,345,678.90"
â”‚
â””â”€ ğŸ“Š Query Results
   â””â”€ {"total_revenue": 12345678.90}
```

## Trace Components Explained

### SQL Queries Section
Shows all SQL queries generated by the agent. Useful for:
- Understanding what query was actually executed
- Debugging query issues
- Learning SQL patterns
- Verifying query correctness

### Agent Reasoning Steps
Shows the ReAct (Reasoning + Acting) pattern:
- **Thought**: Agent analyzes the question
- **Action**: Agent chooses which tool to use
- **Action Input**: Parameters for the tool
- **Observation**: Results from tool execution
- **Final Answer**: Formatted response to user

### Query Results
Raw data returned from the database (if captured)

### Errors
Any errors encountered:
- SQL syntax errors
- Database connection issues
- Agent reasoning failures
- Code execution errors

## Use Cases

### 1. Learning SQL
- See how natural language maps to SQL
- Understand query patterns
- Learn best practices

### 2. Debugging
- Identify where queries fail
- See exact SQL being executed
- Understand agent reasoning

### 3. Performance Analysis
- Check execution times
- Identify slow queries
- Optimize based on traces

### 4. Verification
- Confirm correct queries are generated
- Validate agent reasoning
- Ensure data accuracy

## Technical Details

### Trace Storage
- Traces are stored in `st.session_state.query_traces`
- One trace per query/response
- Persists during session
- Cleared on "Reset Chat"

### Trace Extraction
- SQL queries extracted using regex patterns
- Agent steps parsed from agent output
- Errors captured from exceptions
- Timing measured with `time.time()`

### Display
- Expandable sections for clean UI
- Syntax highlighting for SQL/code
- Color-coded icons for step types
- Timestamps for each component

## Tips

1. **Enable traces** when learning or debugging
2. **Disable traces** for cleaner interface during normal use
3. **Check SQL queries** to verify correctness
4. **Review agent steps** to understand reasoning
5. **Monitor execution time** for performance

## Future Enhancements

Potential improvements:
- Export traces to JSON/CSV
- Trace comparison between queries
- Performance metrics dashboard
- Query optimization suggestions
- Historical trace analysis

